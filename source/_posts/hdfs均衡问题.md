---
title: hdfs均衡问题
date: 2026-01-05 16:40:04
tags: [hdfs]
categories:
  - [hdfs]
---

http://jr.dahuatech.com:8080/browse/HDP-4539

### 现象

均衡执行完毕后，dn之间的存储还是相差很大

![均衡执行完毕后效果](E:\github博客\技术博客\source\images\hdfs均衡问题\dn中的文件分布.png)

<!--more-->

### 原因

原因主要有两个：

1、该环境中有极少数大文件和绝大部分的小文件（160w文件，202个大文件，160w小文件。大文件均为50GB左右，占空间8T，小文件只占1+G）

![环境中大文件和小文件分布](E:\github博客\技术博客\source\images\hdfs均衡问题\hdfs文件分布.png)

2、在均衡之前发生了主备切换（改原因导致不均衡详见“主备切换导致不均衡问题”一文）

这两个因素相互作用，导致最后均衡的效果奇差。具体的流程如下：

1、 均衡进程每次迭代默认会移动10GB数据

2、 会调用getBlocks方法10次，每次获取2GB大小的Block信息供移动（2*10GB）

3、 nn在处理getBlocks请求时，会随机生成一个位移（范围为0-该dn上的block数），并从该位移开始遍历返回满足条件的Block（大于10MB）。因为是随机选择的位移，这样理论上每次拿到的Block都是不一样的

4、 均衡拿到需要移动的block后，判断该block是否可以移动，如果可以移动则移动（最重要的条件为block是否已经在目标节点存在）

5、如果连续5个迭代没有任何数据移动，则均衡自动退出

但是叠加上上面两个条件后，意外情况发生了。因为绝大部分的block都小于10MB，所以大于10MB的block是稀疏分布的。多次getBlocks得到的结果雷同性很高。再加上均衡之前发生了主备切换，在下一次dn的全量块汇报之前，block都会处于stale状态，也即均衡的block只会复制，不会删除，因此那些均衡的block不会从源节点dn0中删除。

这就导致每次getBlocks获取到的block基本都是4副本的无法移动的，超过5次后就自动退出了。

